---
title: "Project_4"
author: "Sarah Eiben"
date: '2022-06-14'
output: html_document
---

# Clustering of the signals and enrichment analysis

Our second approach to compare the different family members with eachother is to cluster the signals and do an enrichment analysis with the clusters. After plotting the signals in a combined heatmap, the signals will be clustered and analyzed in an enrichment analysis.

Help for this in the code from lecture 9.

```{r}
suppressPackageStartupMessages({
  library(GenomicRanges)
  library(epiwraps)
  library(ggplot2)
  library(rGREAT)
  library(AnnotationHub)
  library(Rsubread)
  library(rtracklayer)
  library(Biostrings)
  library(Rfastp)
  library(ensembldb)
  library(bsseq)
  library(BiocParallel)
  library(edgeR)
  library(DMRcate)
})
```
## Plotting the signals

As regions we are going to be using the peaks from the different CREB family members that we downloaded in Project_2 and the tracks are the corresponding signal p-values.
We make a list of the signal p-values of the CREB family members.
Then we also make a list of the peak values and merge them together to create one long list of non-overlapping regions.
Finally we combine these in a matrix and create a heatmap.

```{r}
# create a list with all the peaks on chromosome 1
peak_list <- GRangesList("Peaks CREB1"=peaks_creb1_chr1, "Peaks CREB3"=peaks_creb3_chr1, "Peaks CREB3L1"=peaks_creb3l1_chr1, "Peaks CREB5"=peaks_creb5_chr1, compress=TRUE)
# merge the peaks together to create one list of non-overlapping regions
merged_peaks <- reduce(unlist(peak_list))
# make a list of the signal p-values
pv_list <- list(CREB1="signal_pv_creb/signal_pv_creb1.bw", CREB3="signal_pv_creb/signal_pv_creb3.bw", CREB3L1="signal_pv_creb/signal_pv_creb3l1.bw", CREB5="signal_pv_creb/Signal_pv_creb5.bw")
# we obtain the matrix of the signal around the regions:
m_creb1 <- signal2Matrix(pv_list, merged_peaks)
# maybe set an extend and a width?
plotEnrichedHeatmaps(m_creb1)
```
Each row represents the same region across the heatmaps.

Here you can see that there are strongest peaks in CREB3L1, followed by similar looking CREB1 and CREB3 and rather weak looking CREB5.

Analyze this more (not sure if I can speak of strengths of peaks here or what would be correct?).

## Clustering

Now we use clustering to set rows that are similar together and seperate them from the rest.
Let's start by trying with 5 clusters. Then we change the number of clusters until we reach a plateau of the variance explained by clusters.


```{r}
cl <- clusterSignalMatrices(m_creb1, k=10)
# with 5 clusters 73% of the variance is explained by clusters
# with 4 clusters 64 % of the variance is explained by clusters
# with 6 clusters 77%
# with 7 clusters 80%
# with 8 clusters 82%
# with 9 clusters 84%
# with 10 clusters 85%
# with 11 clusters 86%
# so let's go with 10 clusters for a start and see what we can tell.
table(cl)
head(cl)
length(cl)
# The numbers at [1] tell you where your regions are: first region is in cluster 10 with 303 elements
merged_peaks$cluster <- cl
```

### Plotting the clusters

We can split the rows by clusters to visualize this.
The meaning of the cluster is dependent on the order of the matrix, which depends on the order of the rows in the regions.
It's really easy if one generates another regions list that is ordered  and one keeps the same cluster identities everything will be messed up!
We have to keep in mind that the orders of both of them need to be matched when something is changed.
Typically when clusters are exhausting most of the pattern in the data, the results are more stable. For reproducibility of workflows it is important to set the seed, we chose to set the seed at 123.

```{r}
set.seed(123)
plotEnrichedHeatmaps(m_creb1, row_split=cl)
```
Interpretation:

Cluster 1: Represented in all CREB family members except for CREB5.
Cluster 2: Weak representation in all but CREB3.
Cluster 3: A cluster of few regions strong in CREB1 and CREB3L1.
Cluster 4: Medium representation in CREB1, CREB3 and CREB3L1 and barely any representation in CREB5.
Cluster 5: Strong in CREB3 and one of the few that is also represented quite strongly in CREB5.
Cluster 6: Strong in CREB1 and CREB3L1.
Cluster 7: Similar to Cluster 6.
Cluster 8: Seems to be something especially strongly represented by CREB1.
Cluster 9: A cluster of few regions remarkably strong and broad peaked in CREB3.
Cluster 10: Similar to clusters 6 and 7 but broader and stronger peaks.

The curves at the top is the average signal across all the regions but with clusters we have multiple lines. But we cannot tell which one is which.
So we set colors.

#### Adding colors

```{r}
# create a vector of colors and have as names of the vector the names of our clusters (in this case just numbers).
mycolors <- c("1"="yellow", "2"="orange", "3"="red", "4"="pink", "5"="purple", "6"="blue", "7"="green", "8"="brown", "9"="gray", "10"="black")
plotEnrichedHeatmaps(m_creb1, row_split=cl, mean_color=mycolors, trim=c(0.95))
```
Bring the curves into the representation!

## Plotting just the averages

We tried to extract the average signals to get a more broad overview of the signals, we can also do this by cluster.
This gives us a data frame that has for each cluster for each sample or signal at each position the value of the mean signal.
We can use this to create a plot that tells us in each cluster what the average signals of each factor around the positions around the regions of interest are.

```{r}
d <- meltSignals(m_creb1, splitBy=cl)
ggplot(d, aes(position, mean, colour=sample)) + geom_line(size=1.2) + facet_wrap(~split)
```

These plots are exactly like the plots above the heat maps with the difference that instead of plotting the different lines for one signal together we are plotting the lines for one cluster but different signals together. You can plot whatever you want.

Clustering is dangerous because you might change around factors until you like the result.

From this plot we can generally tell once more that CREB5 is not very strongly involved in any of these peaks. All the other family members have some clusters that they are the strongest representative which means they might be strongly involved in whatever these processes represent.

More analyis here?

# Enrichment analysis

Now we want to figure out what the regions are. For example what are the regions in cluster 1, are they associated with or close to genes that have a different kind of function than the regions in cluster 5?
Typically you add more signals in order to find more patterns of correlation. Are they bound by other factors?

Find what's enriched in one cluster with respect to the others:

```{r}
# we first split the regions by cluster:
split_regions <- split(merged_peaks, cl)
# Important: when a job is submitted to GREAT a set of regions, a GRanges object, needs to be submitted BUT there also needs to be some sort of background added to the picture. The elements in a list of regions are always compared to other elements. So we are comparing the regions in cluster 6 with respect to all our other regions.
# sending the data to the server
job <- submitGreatJob(split_regions[["6"]], merged_peaks, species="hg38")
#Human GRCh38/hg38 is the genome we used
job
# we fetch the data back
res <- getEnrichmentTables(job)
names(res)
```
Molecular function is about being enzymes, signalling proteins, biological process is what they are involved in and cellular component is where they work. This gives us an overview.

## Plotting the top Biological Processes, molecular functions and cellular components

```{r, fig.width=9, fig.height=6}
# looking at the biological processes
bp <- res$`GO Biological Process`
head(bp)
# reorder it from most to least statistically significant before being alphabetically ordered.
ggplot(head(bp,20), aes(Hyper_Fold_Enrichment, reorder(name, Hyper_Adjp_BH), size=Hyper_Foreground_Region_Hits, color=-log10(Hyper_Adjp_BH))) + geom_point() + scale_color_viridis_c()

# looking at the molecular function
mf <- res$`GO Molecular Function`
head(mf)
ggplot(head(mf,20), aes(Hyper_Fold_Enrichment, reorder(name, Hyper_Adjp_BH), size=Hyper_Foreground_Region_Hits, color=-log10(Hyper_Adjp_BH))) + geom_point() + scale_color_viridis_c()

# looking at cellular components
cc <- res$`GO Cellular Component`
ggplot(head(cc,20), aes(Hyper_Fold_Enrichment, reorder(name, Hyper_Adjp_BH), size=Hyper_Foreground_Region_Hits, color=-log10(Hyper_Adjp_BH))) + geom_point() + scale_color_viridis_c()
```
We get different genotology terms and it is telling us how many regions in our background are associated with this term and how many regions in our foreground, so the genes of interest are associated with this.
Fold Enrichment is how much more we have in our region of interest than in the background.

On the x-axis is the strength of enrichment and the color of the dot represents its significance.
Smaller sets need more enrichment in order to be significant than large sets. That's why we look at both the significance and the fold enrichment which indicates the magnitude of enrichment.
Disclaimer: not everything makes sense because the same genes get reused in many biological processes, but we can learn something about what the clusters do.

Analyze this:

Now we only did this for cluster 6 compared to all clusters. We need to do more comparisons like this and figure out what cluster stands for what.

```{r}
sessionInfo()
```