---
title: "Project_5"
author: "Sarah Eiben, Michelle Baumgartner, Deni Hodzic"
date: '2022-06-14'
output: html_document
---

# Adding the cofactors and one acetylation to the analysis

```{r}
# get the regions on the cofactors and the methylation for just chromosome 1
# CREBBP
peaks_crebbp_chr1 <- peaks_crebbp[seqnames(peaks_crebbp)=="chr1"]
# CREB3
peaks_jun_chr1 <- peaks_jun[seqnames(peaks_jun)=="chr1"]
# CREB3L1
peaks_ep300_chr1 <- peaks_ep300[seqnames(peaks_ep300)=="chr1"]
# CREB5
peaks_hdac2_chr1 <- peaks_hdac2[seqnames(peaks_hdac2)=="chr1"]
# H3K27ac
peaks_h3k27ac_chr1 <- peaks_h3k27ac[seqnames(peaks_h3k27ac)=="chr1"]
```

## Creating a regionOverlap and a regionUpset for all CREB family members for chromosome 1 AND the cofactors and acetylation

We make a list of regions that includes the cofactors and the acetylation to it and use this list to do another regionOverlaps and regionUpset plot.

```{r}

listofRegions_cf <- list(creb1=peaks_creb1_chr1, creb3=peaks_creb3_chr1, creb3l1=peaks_creb3l1_chr1, creb5=peaks_creb5_chr1, crebbp=peaks_crebbp, jun=peaks_jun, ep300=peaks_ep300, hdac2=peaks_hdac2, h3k27ac=peaks_h3k27ac)
regionOverlaps(listofRegions_cf)
regionUpset(listofRegions_cf)
```
What stands out in the RegionOverlaps plot is that the cofactors overlap strongly with one another and the overlaps of the cofactors with the CREB family members is in around the same dimension except for CREB5, which shows lower overlaps.
CREBBP seems to have not very many overlapping regions with anything.

The RegionUpset plot shows that the acetylations have by far the biggest intersection size and most intersections are also shown with its involvement. This acetylation seems to be very present.

### Creating different regionOverlap plots and regionUpset plots to see it more clearly

Following we are creating more specific plots by focusing on one cofactor or acetylation. We add our focus into the list of CREB family members and leave the others away.
To analyze these we can set the reference to different CREB family members which might give us some different information.

```{r}
# CREBBP
listofRegions_crebbp <- list(creb1=peaks_creb1_chr1, creb3=peaks_creb3_chr1, creb3l1=peaks_creb3l1_chr1, creb5=peaks_creb5_chr1, crebbp=peaks_crebbp_chr1)
regionOverlaps(listofRegions_crebbp)
regionUpset(listofRegions_crebbp, reference = peaks_crebbp_chr1)
```
CREBBP seems not to have very many overlaps with any of the CREB family members on chromosome 1.

```{r}
# JUN
listofRegions_jun <- list(creb1=peaks_creb1_chr1, creb3=peaks_creb3_chr1, creb3l1=peaks_creb3l1_chr1, creb5=peaks_creb5_chr1, jun=peaks_jun_chr1)
regionOverlaps(listofRegions_jun)
regionUpset(listofRegions_jun, reference = peaks_jun_chr1)
```
JUN has most overlaps with CREB1 and CREB3L1.


```{r}
# EP300
listofRegions_ep300 <- list(creb1=peaks_creb1_chr1, creb3=peaks_creb3_chr1, creb3l1=peaks_creb3l1_chr1, creb5=peaks_creb5_chr1, ep300=peaks_ep300_chr1)
regionOverlaps(listofRegions_ep300)
regionUpset(listofRegions_ep300, reference = peaks_ep300_chr1)
```
EP300 seems to have intersections with all CREB family members, most with CREB1, then CREB3L1, then CREB3 and even with CREB5.

```{r}
# HDAC2
listofRegions_hdac2 <- list(creb1=peaks_creb1_chr1, creb3=peaks_creb3_chr1, creb3l1=peaks_creb3l1_chr1, creb5=peaks_creb5_chr1, hdac2=peaks_hdac2_chr1)
regionOverlaps(listofRegions_hdac2)
regionUpset(listofRegions_hdac2, reference = peaks_hdac2_chr1)
```
HDAC2 has a similar overlap pattern to EP300.

```{r}
# H3K27ac
listofRegions_h3k27ac <- list(creb1=peaks_creb1_chr1, creb3=peaks_creb3_chr1, creb3l1=peaks_creb3l1_chr1, creb5=peaks_creb5_chr1, h3k27ac=peaks_h3k27ac_chr1)
regionOverlaps(listofRegions_h3k27ac)
regionUpset(listofRegions_h3k27ac, reference = peaks_h3k27ac_chr1)
regionUpset(listofRegions_h3k27ac, reference = peaks_creb1_chr1)
# comparing H3K27ac to the cofactors
listofRegions_h3k27ac_2 <- list(crebbp=peaks_crebbp_chr1, jun=peaks_jun_chr1, ep300=peaks_ep300_chr1, hdac2=peaks_hdac2_chr1, h3k27ac=peaks_h3k27ac_chr1)
regionOverlaps(listofRegions_h3k27ac_2)
regionUpset(listofRegions_h3k27ac_2, reference = peaks_h3k27ac_chr1)
```

H3K27ac seems to intersect most with CREB1, then CREB3L1, CREB3 and barely with CREB5. From the cofactors it has noticeable intersections with hdac2 and ep300.


## Doing analysis according to clusters

Let's look at how the different clusters interact with the cofactors and the methylation.

```{r}
# create a list with all the peaks on chromosome 1
peak_list_cf <- GRangesList("Peaks CREB1"=peaks_creb1_chr1, "Peaks CREB3"=peaks_creb3_chr1, "Peaks CREB3L1"=peaks_creb3l1_chr1, "Peaks CREB5"=peaks_creb5_chr1, "Peaks CREBBP"=peaks_crebbp_chr1, "Peaks JUN"=peaks_jun_chr1, "Peaks EP300"=peaks_ep300_chr1, "Peaks HDAC2"=peaks_hdac2_chr1, "Peaks H3K27ac"=peaks_h3k27ac_chr1, compress=TRUE)
# merge the peaks together to create one list of non-overlapping regions
merged_peaks_cf <- reduce(unlist(peak_list_cf))
# make a list of the signal p-values
pv_list_cf <- list(CREB1="signal_pv_creb/signal_pv_creb1.bw", CREB3="signal_pv_creb/signal_pv_creb3.bw", CREB3L1="signal_pv_creb/signal_pv_creb3l1.bw", CREB5="signal_pv_creb/Signal_pv_creb5.bw", CREBBP="signal_pv_cofactors/signal_pv_crebbp.bw", JUN="signal_pv_cofactors/signal_pv_jun.bw", EP300="signal_pv_cofactors/signal_pv_ep300.bw", HDAC2="signal_pv_cofactors/signal_pv_hdac2.bw", H3K27ac="H3K27ac/h3k27ac_signal_pv.bw")
# we obtain the matrix of the signal around the regions:
m_creb1_cf <- signal2Matrix(pv_list_cf, merged_peaks_cf)
# maybe set an extend and a width?
plotEnrichedHeatmaps(m_creb1_cf, row_title="Clustered analysis")
```

As you can see in the average plots, the basic normalization based on library size wasn't quite sufficient. While the size of the peak in the middle depends on the amount of the protein, we would expect the background around it to flatten to a similar level across experiments, which isn't the case.

Thus we try to correct for this by trying two approaches.

### Approach 1: Plot groups of experiments and combine

The first approach is to plot two groups of experiments seperately, so that they have their own color scale and then join them afterwarts.

```{r}
plotEnrichedHeatmaps(m_creb1_cf[1:6], scale_title="density\nCREB members", colors=c("white","darkred"), row_title="Approach 1") + plotEnrichedHeatmaps(m_creb1_cf[7:9], scale_title="density\nothers", row_title="Approach 1")
```

### Approach 2: Re-normalization

The second approach is to re-normalize the signals. This can be done with the function renormalizeBorders (2a).

```{r}
# Approach 2a
plotEnrichedHeatmaps(renormalizeBorders(m_creb1_cf), row_title = "Approach 2")
```

Approach 1 shows more clearly what we want to see, so we continue with that approach.

### Cluster

```{r}
cl_2 <- clusterSignalMatrices(m_creb1_cf, k=5)
# 10 clusters explain 96% of the variance
# 5 clusters explain 91% of the variance
merged_peaks_cf$cluster <- cl_2
```
```{r}
set.seed(124)
plotEnrichedHeatmaps(m_creb1_cf[1:6], row_split = cl_2, scale_title="density\nCREB members", colors=c("white","darkred"), row_title="Approach 1 with clusters") + plotEnrichedHeatmaps(m_creb1_cf[7:9], row_split = cl_2, scale_title="density\nothers", row_title="Approach 1 with clusters")
```

Interpret this.

```{r}
sessionInfo()
```

